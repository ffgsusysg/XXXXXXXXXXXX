<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
        }

        .btn-primary {
            background-color: #2563eb;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .alert-box.success {
            background-color: #10b981;
        }

        .alert-box.error {
            background-color: #ef4444;
        }

        .alert-box.info {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-6 flex justify-center items-center min-h-screen">
    <div class="container bg-white p-8 rounded-lg shadow-md max-w-lg w-full">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-700">ğŸ“š Ø£Ø¯Ø§Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</h1>
        
        <div class="space-y-6">
            <div class="p-4 bg-gray-50 rounded-md border border-gray-200">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯:</h3>
                <input type="text" id="teacherName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³" class="w-full p-2 rounded-md bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="subjectId" placeholder="Subject ID" class="w-full p-2 rounded-md bg-white border border-gray-300 mt-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="itemId" placeholder="Item ID" class="w-full p-2 rounded-md bg-white border border-gray-300 mt-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="subtopicId" placeholder="Subtopic ID" class="w-full p-2 rounded-md bg-white border border-gray-300 mt-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="addTeacher()" class="btn-primary w-full p-2 mt-4 rounded-md text-white font-semibold">â• Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø±Ø³</button>
            </div>

            <div class="p-4 bg-gray-50 rounded-md border border-gray-200">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³:</h3>
                <select id="teacherSelect" class="w-full p-2 rounded-md bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 md:space-x-reverse mt-4">
                    <button onclick="fetchLessons()" class="btn-primary w-full p-2 rounded-md text-white font-semibold">ğŸ“¥ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</button>
                    <button id="exportJsonBtn" onclick="exportToJson()" class="btn-primary w-full p-2 rounded-md text-white font-semibold opacity-50 cursor-not-allowed" disabled>
                        ğŸ“„ ØªØµØ¯ÙŠØ± JSON
                    </button>
                </div>
            </div>
            
            <div id="lessonsContainer" class="p-4 bg-gray-50 rounded-md border border-gray-200">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§:</h3>
                <ul id="lessonsList" class="list-disc pr-6 space-y-1 text-right text-gray-600"></ul>
            </div>

            <div id="jsonContainer" class="hidden p-4 bg-gray-50 rounded-md border border-gray-200">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Ø¨ÙŠØ§Ù†Ø§Øª JSON:</h3>
                <pre id="jsonOutput" class="bg-gray-200 p-3 rounded-md overflow-auto text-sm text-gray-700 text-left"></pre>
                <button onclick="copyJsonToClipboard()" class="btn-primary w-full p-2 mt-3 rounded-md text-white font-semibold">
                    Ù†Ø³Ø® JSON Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
                </button>
            </div>

            <div id="alertBox" class="alert-box text-center p-3 rounded-md text-white font-bold transition-opacity duration-300 opacity-0"></div>
        </div>
    </div>

    <script>
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
        const BASE_URL = "https://gw.abgateway.com/content/next-item";
        const teacherSelect = document.getElementById("teacherSelect");
        const lessonsList = document.getElementById("lessonsList");
        const jsonContainer = document.getElementById("jsonContainer");
        const jsonOutput = document.getElementById("jsonOutput");
        const exportJsonBtn = document.getElementById("exportJsonBtn");
        const alertBox = document.getElementById("alertBox");

        const motivationalQuranicVerses = [
            "ï´¿ÙˆÙÙ„ÙØ§ ØªÙÙŠÙ’Ø¦ÙØ³ÙÙˆØ§ Ù…ÙÙ† Ø±ÙÙ‘ÙˆÙ’Ø­Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Û– Ø¥ÙÙ†ÙÙ‘Ù‡Ù Ù„ÙØ§ ÙŠÙÙŠÙ’Ø¦ÙØ³Ù Ù…ÙÙ† Ø±ÙÙ‘ÙˆÙ’Ø­Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø§Ù„Ù’Ù‚ÙÙˆÙ’Ù…Ù Ø§Ù„Ù’ÙƒÙØ§ÙÙØ±ÙÙˆÙ†Ùï´¾",
            "ï´¿ÙÙØ¥ÙÙ†ÙÙ‘ Ù…ÙØ¹Ù Ø§Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Ø§ Û Ø¥ÙÙ†ÙÙ‘ Ù…ÙØ¹Ù Ø§Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Ø§ï´¾",
            "ï´¿ÙˆÙÙ„ÙØ³ÙÙˆÙ’ÙÙ ÙŠÙØ¹Ù’Ø·ÙÙŠÙƒÙ Ø±ÙØ¨ÙÙ‘ÙƒÙ ÙÙØªÙØ±Ù’Ø¶ÙÙ‰Ù°ï´¾",
            "ï´¿ÙˆÙÙ…ÙØ§ ØªÙÙˆÙ’ÙÙÙŠÙ‚ÙÙŠ Ø¥ÙÙ„ÙÙ‘Ø§ Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù Ûš Ø¹ÙÙ„ÙÙŠÙ’Ù‡Ù ØªÙÙˆÙÙƒÙÙ‘Ù„Ù’ØªÙ ÙˆÙØ¥ÙÙ„ÙÙŠÙ’Ù‡Ù Ø£ÙÙ†ÙÙŠØ¨Ùï´¾",
            "ï´¿ÙˆÙÙ…ÙÙ† ÙŠÙØªÙÙ‘Ù‚Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙŠÙØ¬Ù’Ø¹ÙÙ„ Ù„ÙÙ‘Ù‡Ù Ù…ÙØ®Ù’Ø±ÙØ¬Ù‹Ø§ï´¾",
            "ï´¿Ù‡ÙÙˆÙ Ø¹ÙÙ„ÙÙŠÙÙ‘ Ù‡ÙÙŠÙÙ‘Ù†ÙŒï´¾",
            "ï´¿ÙˆÙÙ…ÙØ§ ÙƒÙØ§Ù†Ù Ø±ÙØ¨ÙÙ‘ÙƒÙ Ù†ÙØ³ÙÙŠÙ‹Ù‘Ø§ï´¾"
        ];
        
        let allLessons = [];

        function showAlert(message, type) {
            alertBox.textContent = message;
            alertBox.className = `alert-box text-center p-3 rounded-md text-white font-bold transition-opacity duration-300 opacity-100 ${type}`;
            setTimeout(() => {
                alertBox.classList.remove('opacity-100');
                alertBox.classList.add('opacity-0');
            }, 5000);
        }

        function loadTeachers() {
            teacherSelect.innerHTML = '';
            const teachers = JSON.parse(localStorage.getItem("teachers") || "{}");
            
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "--- Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ù‹Ø§ ---";
            teacherSelect.appendChild(defaultOption);
            
            for (const name in teachers) {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                teacherSelect.appendChild(option);
            }
        }

        function addTeacher() {
            const name = document.getElementById("teacherName").value.trim();
            const subject_id = +document.getElementById("subjectId").value;
            const item_id = +document.getElementById("itemId").value;
            const subtopic_id = +document.getElementById("subtopicId").value;

            if (!name || !subject_id || !item_id || !subtopic_id) {
                showAlert("âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.", "error");
                return;
            }

            const teachers = JSON.parse(localStorage.getItem("teachers") || "{}");
            teachers[name] = { subject_id, item_id, subtopic_id };
            localStorage.setItem("teachers", JSON.stringify(teachers));
            loadTeachers();
            showAlert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­.", "success");
        }

        async function fetchLessons() {
            const selectedTeacher = teacherSelect.value;
            if (!selectedTeacher) {
                showAlert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø±Ø³.", "error");
                return;
            }

            lessonsList.innerHTML = '';
            jsonContainer.classList.add('hidden');
            exportJsonBtn.disabled = true;
            exportJsonBtn.classList.add('opacity-50', 'cursor-not-allowed');
            showAlert("â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª...", "info");

            const { subject_id, item_id: startItemId, subtopic_id: startSubtopicId } = JSON.parse(localStorage.getItem("teachers"))[selectedTeacher];

            let item_id = startItemId;
            let subtopic_id = startSubtopicId;
            const item_type = "lesson";
            allLessons = [];

            try {
                while (true) {
                    const params = new URLSearchParams({
                        subject_id,
                        item_id,
                        subtopic_id,
                        item_type
                    });

                    const res = await fetch(`${BASE_URL}?${params.toString()}`, {
                        headers: { "User-Agent": "Mozilla/5.0" }
                    });

                    if (!res.ok) {
                        throw new Error("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ø´Ø¨ÙƒØ©.");
                    }

                    const json = await res.json();
                    const data = json.data;

                    if (!data || data.length === 0) {
                        break;
                    }

                    const lesson = data[0];
                    const title = (lesson.title_ar || "").trim();
                    item_id = lesson.id;
                    subtopic_id = lesson.subtopic_id;

                    if (title.includes("Ù‚Ø±ÙŠØ¨")) {
                        continue;
                    }
                    
                    allLessons.push(lesson);
                    
                    const listItem = document.createElement("li");
                    listItem.className = "text-gray-600";
                    listItem.textContent = `ğŸ¥ ${lesson.title_ar} (ID: ${lesson.id})`;
                    lessonsList.appendChild(listItem);
                }

                if (allLessons.length > 0) {
                    showAlert(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${allLessons.length} Ù…Ø­Ø§Ø¶Ø±Ø©.`, "success");
                    exportJsonBtn.disabled = false;
                    exportJsonBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    showAlert("ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©.", "error");
                }

            } catch (err) {
                showAlert(`âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${err.message}`, "error");
                console.error(err);
            }
        }

        function exportToJson() {
            if (allLessons.length === 0) {
                showAlert("ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.", "error");
                return;
            }

            const selectedTeacherName = teacherSelect.value;
            const reversedLessons = [...allLessons].reverse();

            const lectures = reversedLessons.map((lesson, index) => ({
                title: lesson.title_ar,
                description: motivationalQuranicVerses[index % motivationalQuranicVerses.length],
                url: lesson.lesson_url
            }));

            const jsonObject = {
                classes: [{
                    name: selectedTeacherName,
                    lectures: lectures
                }]
            };

            const jsonString = JSON.stringify(jsonObject, null, 2);

            jsonOutput.textContent = jsonString;
            jsonContainer.classList.remove('hidden');
            showAlert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù JSON Ø¨Ù†Ø¬Ø§Ø­.", "success");
        }
        
        function copyJsonToClipboard() {
            const textToCopy = jsonOutput.textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                showAlert("âœ… ØªÙ… Ù†Ø³Ø® Ù…Ø­ØªÙˆÙ‰ JSON Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!", "success");
            }).catch(err => {
                showAlert("âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.", "error");
                console.error('Failed to copy text: ', err);
            });
        }

        window.onload = loadTeachers;
    </script>
</body>
</html>
